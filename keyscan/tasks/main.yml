---

- name: a keytype is specified
  assert:
    that: ssh.keyscan.keytype is defined
    msg: no keytype is specified

- name: input file for ssh-keyscan
  delegate_to: localhost
  template:
    src: ssh-keyscan.j2
    dest: "{{ playbook_dir }}/files/ssh/{{ inventory_hostname }}.keyscan"

- name: get {{ ssh.keyscan.keytype }} key
  command: ssh-keyscan -t {{ ssh.keyscan.keytype }} -p {{ ansible_port|default('22') }} -f {{ playbook_dir }}/files/ssh/{{ inventory_hostname }}.keyscan
  delegate_to: localhost
  register: _ssh_keys
  check_mode: no
  changed_when: no

- name: check if key(s) is present
  command: grep -Eq '{{ inventory_hostname }}(.+){{ ssh.keyscan.keytype }} ' {{ ssh.keyscan.known_hosts }}
  delegate_to: localhost
  register: _ssh_key_is_present
  failed_when: no
  check_mode: no
  changed_when: no

- name: put keys into known_hosts
  delegate_to: localhost
  lineinfile:
    line: "{{ item }}"
    path: "{{ ssh.keyscan.known_hosts }}"
    regexp: "{{ inventory_hostname }}(.+){{ ssh.keyscan.keytype }}"
    create: yes
  with_items: "{{ _ssh_keys.stdout_lines }}"
  when:
    - 'item | search(ssh.keyscan.keytype)'
    - "_ssh_key_is_present.rc == 1"
